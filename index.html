<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Index</title>
  <link rel="stylesheet" href="bootstrap-theme.css" media="screen">
  <link rel="stylesheet" href="bootstrap.min.css" media="screen">
  <link rel="stylesheet" type="text/css" href="index.css">
  <script src="jquery-2.1.0.min.js"></script>
</head>

<script type="text/javascript">
</script>

<script type="text/javascript">
  const s = 4;
  var newx = -1;
  var newy = -1;
  var isnew = false;
  var ismove = false;
  var a = new Array();
  for (var i = 0; i < s; i ++) {
    a[i] = new Array();
    for (var j = 0; j < s; j ++)
      a[i][j] = Math.floor(Math.random()*2 + 1) * 2;
  }

  function display_div() {
    var n = "#d";
    for (var i = 0; i < s; i ++)
      for (var j = 0; j < s; j ++) {
        if (isnew == true && newx == i && newy == j) {
          $(n+(i*s+j)).html("<div class='tile tile-new tile-"+a[i][j]+"'>"+a[i][j]+"</div></div>");
          continue;
        }
        if (a[i][j] == 0)
          $(n+(i*s+j)).html("<div class='tile tile-"+a[i][j]+"'>"+"</div></div>");
        else if (a[i][j] >= 10000)
          $(n+(i*s+j)).html("<div class='tile tile-super'>"+a[i][j]+"</div></div>");
        else
          $(n+(i*s+j)).html("<div class='tile tile-"+a[i][j]+"'>"+a[i][j]+"</div>");
      }
  }

  function left(t, i) {
    var len = t[i].length;
    for (var j = 0; j < len-1; j ++)
      if (t[i][j] == 0 && t[i][j+1] != 0) {
        temp = t[i][j];
        t[i][j] = t[i][j+1];
        t[i][j+1] = temp;
        ismove = true;
        left(t, i);
      }
  }

  function right(t, i) {
    var len = t[i].length;
    for (var j = len-1; j > 0; j --)
      if (t[i][j] == 0 && t[i][j-1] != 0) {
        temp = t[i][j];
        t[i][j] = t[i][j-1];
        t[i][j-1] = temp;
        ismove = true;
        right(t, i);
      }
  }

  function up(t, j) {
    var len = t.length;
    for (var i = 0; i < len-1; i ++)
      if (t[i][j] == 0 && t[i+1][j] != 0) {
        temp = t[i][j];
        t[i][j] = t[i+1][j];
        t[i+1][j] = temp;
        ismove = true;
        up(t, j);
      }
  }

  function down(t, j) {
    var len = t.length;
    for (var i = len-1; i > 0; i --)
      if (t[i][j] == 0 && t[i-1][j] != 0) {
        temp = t[i][j];
        t[i][j] = t[i-1][j];
        t[i-1][j] = temp;
        ismove = true;
        down(t, j);
      }
  }

  function left_combine(a, i) {
    var len = a[i].length;
    var now = 0;
    var nxt = 1;
    while (now <= len-2) {
      if (a[i][now] == 0 || nxt == len) {
        now ++;
        nxt = now+1;
        continue;
      }
      if (a[i][nxt] == 0) {
        nxt ++;
        continue;
      }
      if (a[i][now] == a[i][nxt]) {
        a[i][now] *= 2;
        a[i][nxt] = 0;
        now = nxt+1;
        nxt = now+1;
        ismove = true;
        continue;
      }
      else {
        now = nxt;
        nxt = now+1;
      }
    }
    left(a, i);
  }

  function right_combine(a, i) {
    var len = a[i].length;
    var now = len-1;
    var nxt = len-2;
    while (now >= 1) {
      if (a[i][now] == 0 || nxt == -1) {
        now --;
        nxt = now-1;
        continue;
      }
      if (a[i][nxt] == 0) {
        nxt --;
        continue;
      }
      if (a[i][now] == a[i][nxt]) {
        a[i][now] *= 2;
        a[i][nxt] = 0;
        now = nxt-1;
        nxt = now-1;
        ismove = true;
        continue;
      }
      else {
        now = nxt;
        nxt = now-1;
      }
    }
    right(a, i);
  }

  function up_combine(a, j) {
    var len = a.length;
    var now = 0;
    var nxt = 1;
    while (now <= len-2) {
      if (a[now][j] == 0 || nxt == len) {
        now ++;
        nxt = now+1;
        continue;
      }
      if (a[nxt][j] == 0) {
        nxt ++;
        continue;
      }
      if (a[now][j] == a[nxt][j]) {
        a[now][j] *= 2;
        a[nxt][j] = 0;
        now = nxt+1;
        nxt = now+1;
        ismove = true;
        continue;
      }
      else {
        now = nxt;
        nxt = now+1;
      }
    }
    up(a, j);
  }

  function down_combine(a, j) {
    var len = a.length;
    var now = len-1;
    var nxt = len-2;
    while (now >= 1) {
      if (a[now][j] == 0 || nxt == -1) {
        now --;
        nxt = now-1;
        continue;
      }
      if (a[nxt][j] == 0) {
        nxt --;
        continue;
      }
      if (a[now][j] == a[nxt][j]) {
        a[now][j] *= 2;
        a[nxt][j] = 0;
        now = nxt-1;
        nxt = now-1;
        ismove = true;
        continue;
      }
      else {
        now = nxt;
        nxt = now-1;
      }
    }
    down(a, j);
  }

  function check(a) {
    for (var i = 0; i < s; i ++)
      for (var j = 0; j < s; j ++)
        if (a[i][j] == 0)
          return true;
    isnew = false;
    return false;
  }

  function addnew() {
    while (check(a) == true) {
      pos = Math.floor(Math.random()*16);
      var i = Math.floor(pos/s);
      var j = Math.floor(pos%s);
      if (a[i][j] == 0) {
        a[i][j] = Math.floor(Math.random()*2 + 1) * 2;
        newx = i;
        newy = j;
        isnew = true;
        break;
      }
    }
  }

  function left_go() {
    ismove = false;
    for (var i = 0; i < s; i ++) {
      left(a, i);
    }
    for (var i = 0; i < s; i ++)
      left_combine(a, i);
    if (ismove == true)
      addnew();
    display_div();
  }

  function up_go() {
    ismove = false;
    for (var j = 0; j < s; j ++) {
      up(a, j);
    }
    for (var j = 0; j < s; j ++)
      up_combine(a, j);
    if (ismove == true)
      addnew();
    display_div();
  }

  function right_go() {
    ismove = false;
    for (var i = 0; i < s; i ++) {
      right(a, i);
    }
    for (var i = 0; i < s; i ++)
      right_combine(a, i);
    if (ismove == true)
      addnew();
    display_div();
  }

  function down_go() {
    ismove = false;
    for (var j = 0; j < s; j ++) {
      down(a, j);
    }
    for (var j = 0; j < s; j ++)
      down_combine(a, j);
    if (ismove == true)
      addnew();
    display_div();
  }

  $(document).ready(function() {
    display_div();
    $(document).keyup(function(key_in) {
      console.log(key_in.keyCode);
      if (key_in.keyCode == 37) {
        left_go();
      }
      if (key_in.keyCode == 38) {
        up_go();
      }
      if (key_in.keyCode == 39) {
        right_go();
      }
      if (key_in.keyCode == 40) {
        down_go();
      }
    });
  });

  var count = 0;
  var stopFlag = true;
  function ai_go() {
    document.getElementById("test1").innerHTML = "running";
    if (stopFlag == false) {
      document.getElementById("test1").innerHTML = "stopped";
      return;
    }
    if (count % 4 == 0)
      left_go();
    else if (count % 4 == 1)
      up_go();
    else if (count % 4 == 2)
      right_go();
    else if (count % 4 == 3)
      down_go();
    count ++;
    document.getElementById("test3").innerHTML = count;
    setTimeout(function() {
      ai_go();
    }, 300);
  }

  $(document).keyup(function(key_in) {
    console.log(key_in.keyCode);
    if (key_in.keyCode == 190) {
      stopFlag = false;
    }
    setTimeout(function() {
      stopFlag = true;
    }, 500);
  });

</script>

<body>
  <div class="row-fluid">
  <div class="col-md-6">
    <div class="grid-row">
      <div class="grid-cell" id="d0"></div>
      <div class="grid-cell" id="d1"></div>
      <div class="grid-cell" id="d2"></div>
      <div class="grid-cell" id="d3"></div>
    </div>
    <div class="grid-row">
      <div class="grid-cell" id="d4"></div>
      <div class="grid-cell" id="d5"></div>
      <div class="grid-cell" id="d6"></div>
      <div class="grid-cell" id="d7"></div>
    </div>
    <div class="grid-row">
      <div class="grid-cell" id="d8"></div>
      <div class="grid-cell" id="d9"></div>
      <div class="grid-cell" id="d10"></div>
      <div class="grid-cell" id="d11"></div>
    </div>
    <div class="grid-row">
      <div class="grid-cell" id="d12"></div>
      <div class="grid-cell" id="d13"></div>
      <div class="grid-cell" id="d14"></div>
      <div class="grid-cell" id="d15"></div>
    </div>
  </div>
  <div class="col-md-2">
    <h3 id="test1"> test1 </h3>
    <h3 id="test2"> test2 </h3>
    <h3 id="test3"> test3 </h3>
    <button class="btn btn-large btn-primary btn-block" type="submit" onClick="ai_go()">
      <h3> GO </h3>
    </button>
  </div>
  </div>
</body>
</html>
